package {{importPackages.stubPackage}};

import com.github.tomakehurst.wiremock.WireMockServer;
import com.github.tomakehurst.wiremock.client.WireMock;
import com.github.tomakehurst.wiremock.matching.*;
import com.github.tomakehurst.wiremock.stubbing.StubMapping;
import com.github.tomakehurst.wiremock.stubbing.StubImport;
import {{importPackages.modelPackage}}.*;

import java.util.*;

import static com.github.tomakehurst.wiremock.client.ResponseDefinitionBuilder.jsonResponse;
import static com.github.tomakehurst.wiremock.client.ResponseDefinitionBuilder.like;
import static com.github.tomakehurst.wiremock.client.WireMock.*;

public class {{tag}} {

    {{#paths}}
    public static class {{operationId}} {

        private static final String PATH = "{{path}}";

        private UrlPattern urlPattern;
        private List<ContentPattern> bodyPatterns = new ArrayList<>();
        private final Map<String, StringValuePattern> queryParams = new LinkedHashMap<>();

        {{#queryParams}}
        public {{operationId}} inQuery{{fieldName}}({{{fieldType}}} {{methodFieldName}}) {
            queryParams.put("{{methodFieldName}}", equalTo({{methodFieldName}}.toString()));
            return this;
        }
        {{/queryParams}}
        {{#bodyParams}}
        public {{operationId}} inBody{{compositeFieldName}}({{{fieldType}}} {{methodFieldName}}) {
            MatchesJsonPathPattern pattern = new MatchesJsonPathPattern("{{wayToObject}}", equalTo({{methodFieldName}}.toString()));
            bodyPatterns.add(pattern);
            return this;
        }
        {{/bodyParams}}

        {{#responses}}
        public Code{{code}}Builder code{{code}}(){
            return new Code{{code}}Builder();
        }

        public class Code{{code}}Builder{

            private {{#objectType}}{{objectType}}{{/objectType}}{{#description}}Object{{/description}} response;

            public Code{{code}}Builder(){
                this.response = {{#objectType}}new {{objectType}}(){{/objectType}}{{#description}}"{{description}}"{{/description}};
            }

            {{#fields}}
            public Code{{code}}Builder with{{compositeFieldName}}({{{fieldType}}} {{methodFieldName}}) {
                response{{wayToObject}}.{{setterName}}({{methodFieldName}});
                return this;
            }
            {{/fields}}
            public StubMapping buildStub() {
                return {{httpMethod}}(urlPattern)
                        .withQueryParams(queryParams)
                        .willReturn(like(jsonResponse(response))).build();
            }

            public void mock() {
                {{#importPackages.delegateObject}}
                {{importPackages.delegateObject}}.mock(buildStub());
                {{/importPackages.delegateObject}}
                {{^importPackages.delegateObject}}
                WireMock.importStubs(StubImport.stubImport().stub(buildStub()).build());
                {{/importPackages.delegateObject}}
            }
        }
        {{/responses}}

    }
    {{/paths}}

    private static class CollectionValueBuilder<E, V> {
        private E enter;
        private List<V> collection;
        private V value;

        public CollectionValueBuilder<E, V> addNew() {
            this.collection.add(value);
            return new CollectionValueBuilder<E, V>(enter);
        }

        public CollectionValueBuilder(E enter) {
            this.enter = enter;
        }

        public E exit() {
            return this.enter;
        }
    }
}
